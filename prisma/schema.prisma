generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                     @id @default(uuid())
  name                   String
  email                  String                     @unique
  mobile                 String
  password               String
  role                   Role                       @default(customer)
  tokenVersion           Int                        @default(0)
  createdAt              DateTime                   @default(now())
  isRestricted           Boolean                    @default(false)
  restrictedAt           DateTime?
  restrictedBy           String?
  restrictionLiftedAt    DateTime?
  restrictionReason      String?
  stripeAccountId        String?
  stripeAccountStatus    String?
  stripeOnboardingUrl    String?
  availability           AvailabilityStatus         @default(AVAILABLE)
  addresses              Address[]
  BankAccounts           BankAccount[]
  bookings               Booking[]
  businessProfile        BusinessProfile?
  Businesscategory       Businesscategory[]
  cancellation           Cancellation[]
  carts                  Cart[]
  customerActivityLogs   CustomerActivityLog[]
  CustomerPayment        CustomerPayment[]
  FCMToken               FCMToken[]
  staffFeedbacks         Feedback[]                 @relation("StaffFeedback")
  feedbacks              Feedback[]
  receivedNotifications  Notification[]             @relation("NotificationReceiver")
  sentNotifications      Notification[]             @relation("NotificationSender")
  actorActivityLogs      ProviderAdminActivityLog[] @relation("ActorLogs")
  providerSubscription   ProviderSubscription?
  refreshTokens          RefreshToken[]
  staffApplications      StaffApplications[]
  staffAssignBookings    StaffAssignBooking[]       @relation("AssignedStaff")
  StaffExistFromBusiness StaffExistFromBusiness[]
  staffLeaves            StaffLeave[]               @relation("StaffLeave")
  staffPayments          StaffPayment[]
  staffPaymentRequests   StaffPaymentRequest[]
  staffReviews           StaffReview[]
  staffWeeklySchedules   StaffWeeklySchedule[]      @relation("StaffSchedule")
  UserCardDetails        UserCardDetails[]

  @@index([email])
  @@index([role])
  @@index([isRestricted])
}

model resetToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model UserCardDetails {
  id                  String   @id @default(uuid())
  userId              String
  cardholderName      String
  lastFourDigits      String
  expiryMonth         Int
  expiryYear          Int
  cardType            String
  isDefault           Boolean  @default(false)
  isActive            Boolean  @default(true)
  encryptedCardNumber String
  encryptedCVV        String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
  @@index([isDefault])
}

model BankAccount {
  id                String   @id @default(uuid())
  userId            String
  stripeAccountId   String
  stripeExternalId  String
  bankName          String
  last4             String
  routingNumber     String?
  country           String
  currency          String
  status            String
  isDefault         Boolean  @default(false)
  isActive          Boolean  @default(true)
  accountHolderType String?
  fingerprint       String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([stripeAccountId])
  @@index([stripeExternalId])
  @@index([isActive])
  @@index([isDefault])
}

model BusinessProfile {
  id                        String                   @id @default(uuid())
  userId                    String                   @unique
  businessName              String
  businessCategoryId        String
  contactEmail              String
  phoneNumber               String
  websiteURL                String?
  socialLinks               Json?
  isActive                  Boolean                  @default(true)
  approvedAt                DateTime?
  isApproved                Boolean                  @default(false)
  isRejected                Boolean                  @default(false)
  isRestricted              Boolean                  @default(false)
  rejectedAt                DateTime?
  rejectionReason           String?
  restrictedAt              DateTime?
  restrictedBy              String?
  restrictionLiftedAt       DateTime?
  restrictionReason         String?
  restrictionRequestMessage String?
  Booking                   Booking[]
  category                  Businesscategory         @relation(fields: [businessCategoryId], references: [id])
  user                      User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  carts                     Cart[]
  RestrictionLiftRequest    RestrictionLiftRequest[]
  services                  Service[]
  slots                     Slot[]
  staffApplications         StaffApplications[]
  StaffAssignBooking        StaffAssignBooking[]
  StaffExistFromBusiness    StaffExistFromBusiness[]
  staffReviews              StaffReview[]

  @@index([businessName, contactEmail])
}

model Businesscategory {
  id               String            @id @default(uuid())
  name             String
  description      String
  createdBy        String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  businessProfiles BusinessProfile[]
  user             User              @relation(fields: [createdBy], references: [id])
  services         Service[]
}

model Address {
  id              String            @id @default(uuid())
  street          String
  city            String
  state           String
  postalCode      String
  country         String
  type            AddressType       @default(HOME)
  landmark        String            @default("N/A")
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  Booking         Booking[]
  CustomerPayment CustomerPayment[]

  @@index([userId])
}

model Service {
  id                        String                   @id @default(cuid())
  name                      String
  description               String?
  durationInMinutes         Int
  price                     Int
  totalBookingAllow         Int
  currency                  String                   @default("INR")
  isActive                  Boolean                  @default(true)
  coverImage                String?
  images                    String[]
  averageRating             Float?                   @default(0)
  reviewCount               Int                      @default(0)
  createdAt                 DateTime                 @default(now())
  updatedAt                 DateTime                 @updatedAt
  businessProfileId         String
  businessCategoryId        String
  isRestricted              Boolean                  @default(false)
  restrictedAt              DateTime?
  restrictedBy              String?
  restrictionLiftedAt       DateTime?
  restrictionReason         String?
  restrictionRequestMessage String?
  bookings                  Booking[]
  carts                     Cart[]
  feedback                  Feedback[]
  RestrictionLiftRequest    RestrictionLiftRequest[]
  category                  Businesscategory         @relation(fields: [businessCategoryId], references: [id])
  businessProfile           BusinessProfile          @relation(fields: [businessProfileId], references: [id], onDelete: Cascade)
  StaffAssignBooking        StaffAssignBooking[]
}

model Slot {
  id                 String               @id @default(uuid())
  time               String
  businessProfileId  String?
  bookings           Booking[]
  carts              Cart[]
  businessProfile    BusinessProfile?     @relation(fields: [businessProfileId], references: [id], onDelete: Cascade)
  StaffAssignBooking StaffAssignBooking[]
}

model SiteContent {
  id        String   @id @default(uuid())
  key       String   @unique
  title     String
  content   String
  updatedBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Booking {
  id                     String                @id @default(uuid())
  userId                 String
  addressId              String
  serviceId              String
  businessProfileId      String
  slotId                 String?
  totalAmount            Int
  platformFee            Int?                  @default(0)
  providerEarnings       Int?                  @default(0)
  bookingStatus          BookingStatus         @default(PENDING)
  date                   String
  paymentLink            String?
  isFeedbackProvided     Boolean               @default(false)
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  expiresAt              DateTime?
  trackingStatus         TrackingStatus        @default(NOT_STARTED)
  providerReminderSentAt DateTime?
  reminderSentAt         DateTime?
  staffEarnings          Int?                  @default(0)
  staffPaidAt            DateTime?
  staffPaymentStatus     PaymentStatus         @default(PENDING)
  staffPercentage        Float?                @default(50)
  paymentStatus          PaymentStatus         @default(PENDING)
  address                Address               @relation(fields: [addressId], references: [id], onDelete: Cascade)
  businessProfile        BusinessProfile       @relation(fields: [businessProfileId], references: [id])
  service                Service               @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  slot                   Slot?                 @relation(fields: [slotId], references: [id])
  user                   User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  cancellation           Cancellation?
  feedback               Feedback[]
  StaffAssignBooking     StaffAssignBooking[]
  StaffPayment           StaffPayment[]
  StaffPaymentRequest    StaffPaymentRequest[]

  @@index([userId])
  @@index([businessProfileId])
  @@index([bookingStatus])
  @@index([createdAt])
}

model StaffPaymentRequest {
  id              String        @id @default(uuid())
  bookingId       String
  staffId         String
  providerId      String
  requestedAmount Int
  staffFeedback   String?
  requestStatus   RequestStatus @default(PENDING)
  requestedAt     DateTime      @default(now())
  reviewedAt      DateTime?
  rejectionReason String?
  booking         Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  staff           User          @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([bookingId, staffId])
  @@index([staffId])
  @@index([providerId])
  @@index([requestStatus])
}

model StaffPayment {
  id               String        @id @default(uuid())
  bookingId        String
  staffId          String
  providerId       String
  requestedAmount  Int
  percentage       Float
  staffAmount      Int
  paymentMethod    String        @default("stripe")
  stripeTransferId String?
  paidAt           DateTime      @default(now())
  status           PaymentStatus @default(PENDING)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  booking          Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  staff            User          @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
  @@index([providerId])
  @@index([status])
  @@index([createdAt])
}

model Cancellation {
  id                 String        @id @default(uuid())
  bookingId          String        @unique
  requestedById      String
  reason             String
  reasonType         String
  status             BookingStatus @default(CANCEL_REQUESTED)
  refundStatus       PaymentStatus @default(PENDING)
  refundAmount       Int?
  cancellationFee    Int?
  hoursBeforeService Int?
  refundedAt         DateTime?
  requestedAt        DateTime      @default(now())
  approvedAt         DateTime?
  autoApprovedAt     DateTime?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  booking            Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  requestedBy        User          @relation(fields: [requestedById], references: [id])

  @@index([bookingId])
  @@index([status])
  @@index([refundStatus])
}

model CustomerPayment {
  id              String        @id @default(uuid())
  userId          String
  addressId       String
  amount          Int
  status          PaymentStatus @default(PENDING)
  bookingIds      String
  stripeSessionId String?
  paymentIntentId String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  address         Address       @relation(fields: [addressId], references: [id])
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Cart {
  id         String          @id @default(uuid())
  userId     String
  serviceId  String
  businessId String
  slotId     String
  date       String
  addedAt    DateTime        @default(now())
  business   BusinessProfile @relation(fields: [businessId], references: [id], onDelete: Cascade)
  service    Service         @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  slot       Slot            @relation(fields: [slotId], references: [id], onDelete: Cascade)
  user       User            @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model FCMToken {
  id        String   @id @default(uuid())
  token     String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Notification {
  id         String   @id @default(uuid())
  title      String
  message    String
  read       Boolean  @default(false)
  createdAt  DateTime @default(now())
  receiverId String
  senderId   String?
  receiver   User     @relation("NotificationReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  sender     User?    @relation("NotificationSender", fields: [senderId], references: [id], onDelete: Cascade)
}

model Feedback {
  id           String       @id @default(uuid())
  username     String
  rating       Int
  comment      String
  servicename  String
  createdAt    DateTime     @default(now())
  bookingId    String
  userId       String
  serviceId    String
  feedbackType FeedbackType @default(PROVIDER)
  staffId      String?
  booking      Booking      @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  service      Service      @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  staff        User?        @relation("StaffFeedback", fields: [staffId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ProviderSubscriptionPlan {
  id              String                 @id @default(uuid())
  name            String
  price           Int
  currency        String                 @default("INR")
  interval        String
  stripePriceId   String                 @unique
  trialPeriodDays Int                    @default(0)
  isActive        Boolean                @default(true)
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  maxServices     Int                    @default(5)
  maxBookings     Int                    @default(100)
  commissionRate  Float                  @default(10.0)
  benefits        String[]
  features        Json?
  subscriptions   ProviderSubscription[]
}

model ProviderSubscription {
  id                   String                   @id @default(uuid())
  userId               String                   @unique
  planId               String
  stripeCustomerId     String                   @unique
  stripeSubscriptionId String                   @unique
  status               String
  isActive             Boolean                  @default(true)
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean                  @default(false)
  cancelAt             DateTime?
  createdAt            DateTime                 @default(now())
  updatedAt            DateTime                 @updatedAt
  plan                 ProviderSubscriptionPlan @relation(fields: [planId], references: [id])
  user                 User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model RestrictionLiftRequest {
  id                String          @id
  businessProfileId String
  serviceId         String?
  reason            String
  status            RequestStatus   @default(PENDING)
  adminNote         String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime
  BusinessProfile   BusinessProfile @relation(fields: [businessProfileId], references: [id], onDelete: Cascade)
  Service           Service?        @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([businessProfileId])
  @@index([status])
}

model CustomerActivityLog {
  id         String   @id @default(uuid())
  customerId String
  actionType String
  status     String   @default("SUCCESS")
  bookingId  String?
  paymentId  String?
  serviceId  String?
  metadata   Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  customer   User     @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([actionType])
  @@index([bookingId])
  @@index([paymentId])
  @@index([createdAt])
}

model ProviderAdminActivityLog {
  id                String   @id @default(uuid())
  actorId           String
  actorType         String
  actionType        String
  status            String   @default("SUCCESS")
  businessProfileId String?
  serviceId         String?
  bookingId         String?
  subscriptionId    String?
  metadata          Json?
  ipAddress         String?
  userAgent         String?
  createdAt         DateTime @default(now())
  actor             User     @relation("ActorLogs", fields: [actorId], references: [id], onDelete: Cascade)

  @@index([actorId])
  @@index([actionType])
  @@index([bookingId])
  @@index([serviceId])
  @@index([subscriptionId])
  @@index([createdAt])
}

model StaffAssignBooking {
  id                String           @id @default(uuid())
  bookingId         String
  slotId            String
  businessProfileId String
  serviceId         String
  assignedById      String
  assignedStaffId   String
  status            AssignmentStatus @default(PENDING)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  staffPaymentType  StaffPaymentType @default(PERCENTAGE)
  staffPaymentValue Float            @default(50)
  assignedStaff     User             @relation("AssignedStaff", fields: [assignedStaffId], references: [id], onDelete: Cascade)
  booking           Booking          @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  businessProfile   BusinessProfile  @relation(fields: [businessProfileId], references: [id], onDelete: Cascade)
  service           Service          @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  slot              Slot             @relation(fields: [slotId], references: [id], onDelete: Cascade)

  @@unique([bookingId, assignedStaffId])
  @@index([businessProfileId])
  @@index([assignedStaffId])
  @@index([bookingId])
}

model StaffApplications {
  id                String          @id @default(uuid())
  staffId           String
  businessProfileId String
  status            RequestStatus   @default(PENDING)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  businessProfile   BusinessProfile @relation(fields: [businessProfileId], references: [id], onDelete: Cascade)
  staff             User            @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
  @@index([businessProfileId])
}

model StaffExistFromBusiness {
  id                String          @id @default(uuid())
  staffId           String
  businessProfileId String
  reason            String
  status            RequestStatus   @default(PENDING)
  message           Json?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  businessProfile   BusinessProfile @relation(fields: [businessProfileId], references: [id], onDelete: Cascade)
  staff             User            @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
  @@index([businessProfileId])
}

model StaffReview {
  id                String          @id @default(uuid())
  staffId           String
  businessProfileId String
  rating            Int
  review            String
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  businessProfile   BusinessProfile @relation(fields: [businessProfileId], references: [id], onDelete: Cascade)
  staff             User            @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
  @@index([businessProfileId])
}

model StaffWeeklySchedule {
  id          String   @id @default(uuid())
  staffId     String
  dayOfWeek   Int
  startTime   String
  endTime     String
  isAvailable Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  staff       User     @relation("StaffSchedule", fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([staffId, dayOfWeek])
  @@index([staffId])
}

model StaffLeave {
  id           String        @id @default(uuid())
  staffId      String
  startDate    DateTime
  endDate      DateTime
  startTime    String?
  endTime      String?
  leaveType    LeaveType
  reason       String?
  status       RequestStatus @default(PENDING)
  approvedBy   String?
  approvedAt   DateTime?
  rejectedAt   DateTime?
  rejectReason String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  staff        User          @relation("StaffLeave", fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
  @@index([startDate, endDate])
  @@index([status])
}

enum TrackingStatus {
  NOT_STARTED
  BOOKING_STARTED
  PROVIDER_ON_THE_WAY
  SERVICE_STARTED
  COMPLETED
}

enum AssignmentStatus {
  PENDING
  ACCEPTED
  REJECTED
  COMPLETED
  CANCELLED
}

enum StaffPaymentType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum AvailabilityStatus {
  AVAILABLE
  BUSY
  ON_WORK
  NOT_AVAILABLE
}

enum Role {
  customer
  provider
  admin
  staff
}

enum AddressType {
  HOME
  OFFICE
  OTHER
}

enum BookingStatus {
  PENDING
  PENDING_PAYMENT
  CANCEL_REQUESTED
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  REFUNDED
  FAILED
  CANCELLED
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum FeedbackType {
  STAFF
  PROVIDER
}

enum LeaveType {
  SICK
  VACATION
  PERSONAL
  OTHER
}
