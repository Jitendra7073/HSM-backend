generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// *
///  * ---------------- USER MODEL ----------------
model User {
  id                    String                @id @default(uuid())
  name                  String
  email                 String                @unique
  mobile                String
  password              String
  role                  Role                  @default(customer)
  createdAt             DateTime              @default(now())
  tokenVersion          Int                   @default(0)
  isRestricted          Boolean               @default(false)
  restrictedAt          DateTime?
  restrictedBy          String?
  restrictionLiftedAt   DateTime?
  restrictionReason     String?
  addresses             Address[]
  bookings              Booking[]
  businessProfile       BusinessProfile?
  Businesscategory      Businesscategory[]
  cancellation          Cancellation[]
  carts                 Cart[]
  CustomerPayment       CustomerPayment[]
  FCMToken              FCMToken[]
  feedbacks             Feedback[]
  receivedNotifications Notification[]        @relation("NotificationReceiver")
  sentNotifications     Notification[]        @relation("NotificationSender")
  providerSubscription  ProviderSubscription?
  refreshTokens         RefreshToken[]

  @@index([email])
  @@index([role])
  @@index([isRestricted])
}

/// *
///  * ---------------- RESET TOKEN MODEL ----------------
model resetToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
}

/// *
///  * ---------------- REFRESH TOKEN MODEL ----------------
model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

/// *
///  * ---------------- BUSINESS PROFILE MODEL ----------------
model BusinessProfile {
  id                  String           @id @default(uuid())
  userId              String           @unique
  businessName        String
  businessCategoryId  String
  contactEmail        String
  phoneNumber         String
  websiteURL          String?
  isActive            Boolean          @default(true)
  socialLinks         Json?
  approvedAt          DateTime?
  isApproved          Boolean          @default(false)
  isRejected          Boolean          @default(false)
  rejectedAt          DateTime?
  rejectionReason     String?
  isRestricted        Boolean          @default(false)
  restrictedAt        DateTime?
  restrictedBy        String?
  restrictionLiftedAt DateTime?
  restrictionReason   String?
  Booking             Booking[]
  category            Businesscategory @relation(fields: [businessCategoryId], references: [id])
  user                User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  carts               Cart[]
  services            Service[]
  slots               Slot[]

  @@index([businessName, contactEmail])
}

/// *
///  * ---------------- BUSINESS CATEGORY MODEL ----------------
model Businesscategory {
  id               String            @id @default(uuid())
  name             String
  createdBy        String            @default("admin")
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  description      String
  businessProfiles BusinessProfile[]
  user             User              @relation(fields: [createdBy], references: [id])
  services         Service[]
}

/// *
///  * ---------------- ADDRESS MODEL ----------------
model Address {
  id              String            @id @default(uuid())
  street          String
  city            String
  state           String
  postalCode      String
  country         String
  landmark        String            @default("N/A")
  userId          String
  type            AddressType       @default(HOME)
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  Booking         Booking[]
  CustomerPayment CustomerPayment[]

  @@index([userId])
}

/// *
///  * ---------------- SERVICE MODEL ----------------
model Service {
  id                  String           @id @default(cuid())
  name                String
  description         String?
  durationInMinutes   Int
  price               Int
  currency            String           @default("INR")
  isActive            Boolean          @default(true)
  coverImage          String?
  averageRating       Float?           @default(0)
  reviewCount         Int              @default(0)
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  businessProfileId   String
  businessCategoryId  String
  images              String[]
  totalBookingAllow   Int
  isRestricted        Boolean          @default(false)
  restrictedAt        DateTime?
  restrictedBy        String?
  restrictionLiftedAt DateTime?
  restrictionReason   String?
  bookings            Booking[]
  carts               Cart[]
  feedback            Feedback?
  category            Businesscategory @relation(fields: [businessCategoryId], references: [id])
  businessProfile     BusinessProfile  @relation(fields: [businessProfileId], references: [id], onDelete: Cascade)
}

/// *
///  * ---------------- SLOT MODEL ----------------
model Slot {
  id                String           @id @default(uuid())
  time              String
  businessProfileId String?
  bookings          Booking[]
  carts             Cart[]
  businessProfile   BusinessProfile? @relation(fields: [businessProfileId], references: [id], onDelete: Cascade)
}

/// *
///  * ---------------- BOOKING MODEL ----------------
model Booking {
  id                 String          @id @default(uuid())
  userId             String
  serviceId          String
  businessProfileId  String
  slotId             String?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  addressId          String
  bookingStatus      BookingStatus   @default(PENDING)
  paymentStatus      PaymentStatus   @default(PENDING)
  totalAmount        Int
  date               String
  isFeedbackProvided Boolean         @default(false)
  expiresAt          DateTime?
  paymentLink        String?
  address            Address         @relation(fields: [addressId], references: [id], onDelete: Cascade)
  businessProfile    BusinessProfile @relation(fields: [businessProfileId], references: [id])
  service            Service         @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  slot               Slot?           @relation(fields: [slotId], references: [id])
  user               User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  cancellation       Cancellation?
  feedback           Feedback?

  @@index([userId])
  @@index([businessProfileId])
  @@index([bookingStatus])
  @@index([paymentStatus])
  @@index([createdAt])
}

/// *
///  * ---------------- CANCELLATION MODEL ----------------
model Cancellation {
  id                 String        @id @default(uuid())
  bookingId          String        @unique
  requestedById      String
  reason             String
  reasonType         String
  status             BookingStatus @default(CANCEL_REQUESTED)
  refundStatus       PaymentStatus @default(PENDING)
  refundAmount       Int?
  refundedAt         DateTime?
  /// *
  ///    * ---------------- TIMESTAMPS ----------------
  requestedAt        DateTime      @default(now())
  approvedAt         DateTime?
  autoApprovedAt     DateTime?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  cancellationFee    Int?
  hoursBeforeService Int?
  booking            Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  requestedBy        User          @relation(fields: [requestedById], references: [id])

  @@index([bookingId])
  @@index([status])
  @@index([refundStatus])
}

/// *
///  * ---------------- PAYMENT MODEL ----------------
model CustomerPayment {
  id              String        @id @default(uuid())
  userId          String
  addressId       String
  status          PaymentStatus @default(PENDING)
  amount          Int
  stripeSessionId String?
  paymentIntentId String?
  createdAt       DateTime      @default(now())
  bookingIds      String
  updatedAt       DateTime      @updatedAt
  address         Address       @relation(fields: [addressId], references: [id])
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
}

/// *
///  * ---------------- CUSTOEMR CART MODEL ----------------
model Cart {
  id         String          @id @default(uuid())
  userId     String
  serviceId  String
  addedAt    DateTime        @default(now())
  businessId String
  date       String
  slotId     String
  business   BusinessProfile @relation(fields: [businessId], references: [id], onDelete: Cascade)
  service    Service         @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  slot       Slot            @relation(fields: [slotId], references: [id], onDelete: Cascade)
  user       User            @relation(fields: [userId], references: [id], onDelete: Cascade)
}

/// *
///  * ---------------- FCM TOKEN MODEL ----------------
model FCMToken {
  id        String   @id @default(uuid())
  token     String   @unique
  createdAt DateTime @default(now())
  userId    String
  isActive  Boolean  @default(true)
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

/// *
///  * ---------------- NOTIFICATION MODEL ----------------
model Notification {
  id         String   @id @default(uuid())
  title      String
  message    String
  read       Boolean  @default(false)
  createdAt  DateTime @default(now())
  receiverId String
  senderId   String?
  receiver   User     @relation("NotificationReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  sender     User?    @relation("NotificationSender", fields: [senderId], references: [id], onDelete: Cascade)
}

/// *
///  * ---------------- CUSTOMER FEEDBACK MODEL ----------------
model Feedback {
  id          String   @id @default(uuid())
  rating      Int
  comment     String
  createdAt   DateTime @default(now())
  userId      String
  serviceId   String   @unique
  servicename String
  username    String
  bookingId   String   @unique
  booking     Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  service     Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

/// *
///  * ---------------- PROVIDER SUBSCRIPTION PLAN ----------------
model ProviderSubscriptionPlan {
  id            String                 @id @default(uuid())
  name          String
  price         Int
  currency      String                 @default("INR")
  interval      String
  stripePriceId String                 @unique
  isActive      Boolean                @default(true)
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  subscriptions ProviderSubscription[]
}

/// *
///  * ---------------- PROVIDER SUBSCRIPTION ----------------
model ProviderSubscription {
  id                   String                   @id @default(uuid())
  userId               String                   @unique
  planId               String
  stripeCustomerId     String
  stripeSubscriptionId String                   @unique
  status               String
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  createdAt            DateTime                 @default(now())
  updatedAt            DateTime                 @updatedAt
  plan                 ProviderSubscriptionPlan @relation(fields: [planId], references: [id])
  user                 User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

/// *
///  * ---------------- USER ROLE ENUMS ----------------
enum Role {
  customer
  provider
  admin
}

/// *
///  * ---------------- ADDRESS TYPE ENUMS ----------------
enum AddressType {
  HOME
  OFFICE
  OTHER
}

/// *
///  * ---------------- BOOKING STATUS ENUMS ----------------
enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  PENDING_PAYMENT
  CANCEL_REQUESTED
}

/// *
///  * ---------------- PAYMENT STATUS ENUMS ----------------
enum PaymentStatus {
  PENDING
  PAID
  FAILED
  CANCELLED
  REFUNDED
}
